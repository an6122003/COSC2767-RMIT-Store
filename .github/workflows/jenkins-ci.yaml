name: Jenkins CI BE

on:
  pull_request:
    branches:
      - main
    paths:
      - 'server/**'
  workflow_dispatch:
  repository_dispatch:
    types:
      - trigger-jenkins-ci

jobs:
  trigger-jenkins:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Jenkins Job
        id: trigger
        run: |
          # Define variables
          JOB_NAME="ASM2-Pipeline"
          JENKINS_URL="${{ secrets.JENKINS_URL }}"
          USER="${{ secrets.JENKINS_USER }}"
          API_TOKEN="${{ secrets.JENKINS_API_TOKEN }}"

          # Get Jenkins Crumb
          CRUMB=$(curl -s --user "${USER}:${API_TOKEN}" "${JENKINS_URL}/crumbIssuer/api/json" | jq -r '.crumb')

          # Trigger Jenkins job and get queue URL
          curl -s -X POST "${JENKINS_URL}/job/${JOB_NAME}/build" \
            --user "${USER}:${API_TOKEN}" \
            -H "Jenkins-Crumb:${CRUMB}" \
            -H "Content-Type: application/json" \
            --data-urlencode "pr_number=${{ github.event.pull_request.number }}" \
            --data-urlencode "pr_branch=${{ github.head_ref }}" \
            --data-urlencode "image_tag=${{ github.event.client_payload.image_tag }}" \
            --write-out "%{redirect_url}"

      # Step 5: Wait for Jenkins Job to Complete
      - name: Wait for Jenkins Job
        id: wait_jenkins
        run: |
          JOB_NAME="ASM2-Pipeline"
          JENKINS_URL="${{ secrets.JENKINS_URL }}"
          USER="${{ secrets.JENKINS_USER }}"
          API_TOKEN="${{ secrets.JENKINS_API_TOKEN }}"
          BUILD_URL="$JENKINS_URL/job/$JOB_NAME/lastBuild/api/json"
          STATUS="IN_PROGRESS"

          while [ "$STATUS" != "SUCCESS" ] && [ "$STATUS" != "FAILURE" ]; do
            echo "Checking Jenkins job status..."
            sleep 10
            STATUS=$(curl -s --user $USER:$API_TOKEN $BUILD_URL | jq -r '.result')
            echo "Current status: $STATUS"
          done

          if [ "$STATUS" == "SUCCESS" ]; then
            echo "Jenkins job completed successfully!"
          else
            echo "Jenkins job failed. Exiting with error."
            exit 1
          fi

       # Trigger docker-final-ci Workflow
      - name: Trigger Docker CI Final
        if: ${{ steps.wait_jenkins.outcome == 'SUCCESS' }}
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: trigger-docker-final-ci
          client-payload: |
            {
              "image_tag": "${{ secrets.DOCKER_USERNAME }}/mern-server:${{ env.sha_short }}"
            }
          